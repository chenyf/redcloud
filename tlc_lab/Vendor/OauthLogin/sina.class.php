<?phpinclude_once( 'oauth.class.php' );include_once( 'sina/saetv2.ex.class.php' );class sina{	var $loginUrl;	private $__akey;	private $__skey;	public function __construct() {            $this->__akey = C('SINA_AKEY');            $this->__skey = C('SINA_SKEY');	}	function getUrl($call_back = null) {            if ( empty($this->__akey) || empty($this->__skey) )                return false;            if (is_null($call_back)) {                $call_back = U('User/Oauth/sinaCallback');            }            $o = new SaeTOAuthV2( $this->__akey , $this->__skey );            $code_url = $o->getAuthorizeURL( $call_back );            return $code_url;	}	function getJSON($userid,$passwd){            $o = new WeiboOAuth( $this->__akey , $this->__skey  );            $keys = $o->getRequestToken();            $return = $o->getAuthorizeJSON( $keys['oauth_token'] ,false , $userid,$passwd);            if($return){                $return = json_decode($return);                $o = new WeiboOAuth( $this->__akey , $this->__skey ,$keys['oauth_token'] , $keys['oauth_token_secret']  );                $access_token = $o->getAccessToken(  $return->oauth_verifier ) ;                return $access_token;            }	}	//用户资料	function userInfo(){            $c = new SaeTClientV2( WB_AKEY , WB_SKEY , $_SESSION['sina']['access_token']['oauth_token'] );            $uid_get = $c->get_uid();            $uid = $uid_get['uid'];            $me = $c->show_user_by_id( $uid);//根据ID获取用户等基本信息            $user['id']          = $me['id'];            $user['uname']       = $me['name'];            $user['province']    = $me['province'];            $user['city']        = $me['city'];            $user['location']    = $me['location'];            $user['userface']    = str_replace(  $user['id'].'/50/' , $user['id'].'/180/' ,$me['profile_image_url'] );            $user['sex']         = ($me['gender']=='m')?1:0;            return $user;	}	private function doClient($opt){            $oauth_token = ( $opt['oauth_token'] )? $opt['oauth_token']:$_SESSION['sina']['access_token']['oauth_token'];            //$oauth_token_secret = ( $opt['oauth_token_secret'] )? $opt['oauth_token_secret']:$_SESSION['sina']['access_token']['oauth_token_secret'];            return new SaeTClientV2( $this->__akey , $this->__skey ,  $oauth_token);	}	//验证用户	function checkUser(){            $o = new SaeTOAuthV2( $this->__akey , $this->__skey );            if (isset($_REQUEST['code'])) {                $keys = array();                $keys['code'] = $_REQUEST['code'];                $keys['redirect_uri'] = U('User/Oauth/sinaCallback');                try {                    $token = $o->getAccessToken( 'code', $keys ) ;                    if ($token) {                        $_SESSION['open_platform_type'] = 'sina';                        $_SESSION['sina']['access_token']['oauth_token'] = $token['access_token'];                        $_SESSION['sina']['access_token']['oauth_token_secret'] = $token['uid'];                    }                } catch (\Think\Exception $e) {}            }	}	//发布一条微博	function update($text,$opt){            return $this->doClient($opt)->update($text);	}	//上传一个照片，并发布一条微博	function upload($text,$pic,$opt){            return $this->doClient($opt)->upload($text,$pic);	}        	function follow($uid_or_name,$opt=array()){            return $this->doClient($opt)->follow($uid_or_name);	}}?>